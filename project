from t e n s o r fl o w . k e r a s import u t i l s
from t e n s o r fl o w . k e r a s . models import S e q u e n ti al , model from yaml
from t e n s o r fl o w . k e r a s . l a y e r s import Dense , Dropout , Fl a t t e n
from t e n s o r fl o w . k e r a s . l a y e r s import Conv2D , MaxPooling2D , LSTM, GRU
from t e n s o r fl o w . k e r a s . l a y e r s import TimeDi s t ribu ted , Conv3D , MaxPooling3D ,
ZeroPadding3D
from t e n s o r fl o w . k e r a s import backend a s K
import numpy a s np
import cv2
import math
import random
import mediapipe a s mp
mp drawing = mp. s o l u t i o n s . d r a w i n g u t i l s
mp face mesh = mp. s o l u t i o n s . f a c e m e s h
def p r e p r o c e s s i n g ( cap ) :
e u c l i d d i s t = np . empty ( shape = (25 ,40 ) )
t e r m i n a t e f l a g , count , i n n e r c o u n t = 0 , 0 , 0
#random i z ing t h e 25 frames .
r a n d l i s t = [ 0 , 1 , 2 , 3 , 2 5 , 2 6 , 2 7 , 2 8 ]
key = random . c h oi c e ( r a n d l i s t )
i f key >24:
n o f r ame = l i s t ( range ( key = 2 5 , key ) )
e l s e :
n o f r ame = l i s t ( range ( key , key+25) )
l i p s = [ 0 , 1 3 , 1 4 , 1 7 , 3 7 , 3 9 , 4 0 , 6 1 , 7 8 , 8 0 , 8 1 , 8 2 , 8 4 , 8 7 , 8 8 , 9 1 ,
9 5 , 1 4 6 , 1 7 8 , 1 8 1 , 1 8 5 , 1 9 1 , 2 6 7 , 2 6 9 , 2 7 0 , 2 9 1 , 3 0 8 , 3 1 0 , 3 1 1 , 3 1 2 ,
3 1 4 , 3 1 7 , 3 1 8 , 3 2 1 , 3 2 4 , 3 7 5 , 4 0 2 , 4 0 5 , 4 0 9 , 4 1 5]
while ( cap . isOpened ( ) ) :
r e t , frame = cap . re ad ( )
i f r e t == True :
i f count in n o f r ame :
mean x , mean y = 0 , 0
with mp face mesh . FaceMesh ( s t a ti c im a g e m o d e=True ,
max num faces =1, m i n d e t e c t i o n c o n f i d e n c e =0.5) a s
f a c e m e s h :
# Conver t t h e BGR image t o RGB b e f o r e p r o c e s s i n g .
r e s u l t s = f a c e m e s h . p r o c e s s ( cv2 . c v tC ol o r ( frame , cv2 .
COLOR BGR2RGB) )
# P r i n t and draw f a c e mesh landmarks on t h e image .
i f r e s u l t s . m ul ti f a c e l a n dm a r k s :
for n in l i p s :
x mouth = r e s u l t s . m ul ti f a c e l a n dm a r k s [ 0 ] .
landmark [ n ] . x
y mouth = r e s u l t s . m ul ti f a c e l a n dm a r k s [ 0 ] .
landmark [ n ] . y
shape = frame . shape
r e l a t i v e x = int ( x mouth * shape [ 1 ] )
r e l a t i v e y = int ( y mouth * shape [ 0 ] )
mean x = mean x + r e l a t i v e x
mean y = mean y + r e l a t i v e y
mean x = mean x /40
mean y = mean y /40
i n t c o u n t = 0
for n in l i p s :
x mouth = r e s u l t s . m ul ti f a c e l a n dm a r k s [ 0 ] .
landmark [ n ] . x
y mouth = r e s u l t s . m ul ti f a c e l a n dm a r k s [ 0 ] .
landmark [ n ] . y
shape = frame . shape
r e l a t i v e x = int ( x mouth * shape [ 1 ] )
r e l a t i v e y = int ( y mouth * shape [ 0 ] )
e u c l i d d i s t [ i n n e r c o u n t , i n t c o u n t ] = math . s q r t (
math .pow( ( mean x=r e l a t i v e x ) , 2 )+math .pow( (
mean y=r e l a t i v e y ) , 2 ) )
i n t c o u n t += 1
i n n e r c o u n t +=1
count+=1
e l s e :
break
cap . r e l e a s e ( )
cv2 . destroyAllWindows ( )
return e u c l i d d i s t , 1
def d a t a g e n e r a t o r ( word , n t r ai n , n v al , n t e s t , c l a s s d i c t ) :
#TRAINING SET
f i r s t f l a g , a c t u al c o u n t = 0 , 0
for vid in range ( n t r a i n ) :
i f vid <9:
cap = cv2 . VideoCapture ( ’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/
p r o j e c t d a t a s e t /{0}/ t r a i n /{1} 0 0 0 0 {2}.mp4 ’ . format ( word , word ,
str ( vid +1) ) )
e l i f vid>=9 and vid <99:
cap = cv2 . VideoCapture ( ’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/
p r o j e c t d a t a s e t /{0}/ t r a i n /{1} 0 0 0 {2}.mp4 ’ . format ( word , word ,
str ( vid +1) ) )
e l i f vid>=99 and vid <999:
cap = cv2 . VideoCapture ( ’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/
p r o j e c t d a t a s e t /{0}/ t r a i n /{1} 0 0 {2}.mp4 ’ . format ( word , word ,
str ( vid +1) ) )
e l i f vid ==999:
cap = cv2 . VideoCapture ( ’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/
p r o j e c t d a t a s e t /{0}/ t r a i n /{1} 0 1 0 0 0 . mp4 ’ . format ( word , word ) )
#ONLY FOR FIRST VIDEO
temp , b o o l f l a g = p r e p r o c e s s i n g ( cap )
i f b o o l f l a g == 1 and f i r s t f l a g == 0 :
X t r ai n = temp
f i r s t f l a g = 1
a c t u al c o u n t += 1
#FOR THE REST OF THE VIDEOS
e l i f b o o l f l a g == 1 :
X t r ai n = np . append ( X t r ain , temp , a x i s =0)
a c t u al c o u n t += 1
pr int ( ” {}/{} ” . format ( a c t u al c o u n t , 3 5 0 ) )
X t r ai n = X t r ai n . r e s h a p e ( a c t u al c o u n t , 2 5 , 4 0 ) . a s t y p e ( ’ f l o a t 3 2 ’ )
y t r a i n = [ None ] * a c t u al c o u n t
for i in range ( a c t u al c o u n t ) :
y t r a i n [ i ] = c l a s s d i c t [ word ]
#VALIDATION SET
f i r s t f l a g , a c t u al c o u n t = 0 , 0
for vid in range ( n v al ) :
cap = cv2 . VideoCapture ( ’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/
p r o j e c t d a t a s e t /{0}/ t r a i n /{1} 0 0 {2}.mp4 ’ . format ( word , word , str (
vid +1+750) ) )
temp , b o o l f l a g = p r e p r o c e s s i n g ( cap )
#ONLY FOR FIRST VIDEO
i f b o o l f l a g == 1 and f i r s t f l a g == 0 :
X val = temp
f i r s t f l a g = 1
a c t u al c o u n t += 1
#FOR THE REST OF THE VIDEOS
e l i f b o o l f l a g == 1 :
X val = np . append ( X val , temp , a x i s =0)
a c t u al c o u n t += 1
pr int ( ” {}/{} ” . format ( a c t u al c o u n t , 5 0 ) )
X val = X val . r e s h a p e ( a c t u al c o u n t , 2 5 , 4 0 ) . a s t y p e ( ’ f l o a t 3 2 ’ )
y v al = [ None ] * a c t u al c o u n t
for i in range ( a c t u al c o u n t ) :
y v al [ i ] = c l a s s d i c t [ word ]
#TEST SET
f i r s t f l a g , a c t u al c o u n t = 0 , 0
for vid in range ( n t e s t ) :
i f vid <9:
cap = cv2 . VideoCapture ( ’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/
p r o j e c t d a t a s e t /{0}/ t e s t /{1} 0 0 0 0 {2}.mp4 ’ . format ( word , word ,
str ( vid +1) ) )
e l i f vid>=9 and vid <50:
cap = cv2 . VideoCapture ( ’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/
p r o j e c t d a t a s e t /{0}/ t e s t /{1} 0 0 0 {2}.mp4 ’ . format ( word , word ,
str ( vid +1) ) )
temp , b o o l f l a g = p r e p r o c e s s i n g ( cap )
i f b o o l f l a g == 1 and f i r s t f l a g == 0 :
X t e s t = temp
f i r s t f l a g = 1
a c t u al c o u n t += 1
e l i f b o o l f l a g == 1 :
X t e s t = np . append ( X te s t , temp , a x i s =0)
a c t u al c o u n t += 1
pr int ( ” {}/{} ” . format ( a c t u al c o u n t , 5 0 ) )
X t e s t = X t e s t . r e s h a p e ( a c t u al c o u n t , 2 5 , 4 0 ) . a s t y p e ( ’ f l o a t 3 2 ’ )
y t e s t = [ None ] * a c t u al c o u n t
for i in range ( a c t u al c o u n t ) :
y t e s t [ i ] = c l a s s d i c t [ word ]
y t r a i n = np . a s a r r a y ( y t r a i n )
y t e s t = np . a s a r r a y ( y t e s t )
y v al = np . a s a r r a y ( y v al )
return X t r ain , y t r ai n , X val , y v al , X te s t , y t e s t
def c r e a t e d a t a s e t ( c l a s s d i c t ) :
f i r s t f l a g , c o u n t e r = 0 , 0
for word in c l a s s d i c t . key s ( ) :
trainX , trainY , valX , valY , testX , te s tY = d a t a g e n e r a t o r ( word
, 3 5 0 , 5 0 , 5 0 , c l a s s d i c t )
i f f i r s t f l a g == 0 :
X t r ai n = t r ainX
X t e s t = te s tX
X val = valX
y t r a i n = t r ainY
y t e s t = te s tY
y v al = valY
f i r s t f l a g = 1
e l s e :
X t r ai n = np . append ( X t r ain , trainX , a x i s =0)
X t e s t = np . append ( X te s t , testX , a x i s =0)
X val = np . append ( X val , valX , a x i s =0)
y t r a i n = np . append ( y t r ai n , trainY , a x i s =0)
y t e s t = np . append ( y t e s t , testY , a x i s =0)
y v al = np . append ( y v al , valY , a x i s =0)
c o u n t e r+=1
pr int ( ”Words p r o c e s s e d :{ }/{ } ” . format ( c oun te r , 4 ) )
y t r a i n = u t i l s . t o c a t e g o r i c a l ( y t r a i n )
y t e s t = u t i l s . t o c a t e g o r i c a l ( y t e s t )
y v al = u t i l s . t o c a t e g o r i c a l ( y v al )
return X t r ain , X te s t , X val , y v al , y t r ai n , y t e s t
c l a s s d i c t = { ’ABUSE ’ : 1 , ’BLACK’ : 2 , ’CRIME ’ : 3 , ’EXACTLY’ : 4 }
X t r ain , X te s t , X val , y v al , y t r ai n , y t e s t = c r e a t e d a t a s e t ( c l a s s d i c t )
p=’ / c o n t e n t / d ri v e /MyDrive/ P r o j e c t /LRW/ m a i n f i l e / ’
np . s a ve ( p+’ X t r ai n 3 . npy ’ , X t r ai n )
np . s a ve ( p+’ X t e s t 3 . npy ’ , X t e s t )
np . s a ve ( p+’ X val3 . npy ’ , X val )
np . s a ve ( p+’ y t r a i n 3 . npy ’ , y t r a i n )
np . s a ve ( p+’ y t e s t 3 . npy ’ , y t e s t )
np . s a ve ( p+’ y v al 3 . npy ’ , y v al )
